Like millions of other folks, I have a <a href="https://www.nvidia.com/en-us/shield/">smart</a> TV, 
or simply a tiny android box that lets me play Youtube music and Amazon Prime videos.
I also like to run <a href="https://www.pfsense.org/">pfSense</a> firewall, with pretty much 
out-of-the-box setup.
</p>

While checking firewall logs, and reviewing the usual scans for ports 23/22 from all over the world, 
I started blocking certain geolocations and noticed that every minute or so my smart TV was 
pinging two IPs in China. 
</p>
<p style="text-align: center">
        <a href="../assets/ping-to-china.png">
        <img src="../assets/ping-to-china.png" style="width:500; height: auto">
        </a>
</p>
        
Launching adb, android debugger and digging deeper -- the app responsible for those pings is 
<a href="https://play.google.com/store/apps/details?id=com.waxrain.airplaydmr2&hl=en">com.waxrain.airplaydmr2</a>, 
one of only 3 custom apps installed on the device.
</p>

This got me curious of what other traffic this little android box is leaking. Among the 
usual Nvidia telemetry spam (even though it was explicitly disabled in the OS setttings), 
there is Adobe and Facebook broadcasts. Neither of which I care about.
</p>
<p style="text-align: center">
<a href="../assets/other-unknown-traffic.png">
<img src="../assets/other-unknown-traffic.png" style="width:500; height: auto">
</a>
</p>

With help from pfBlockerNG package, however, we can easily silence this chatter down.
</p>

<h3>Strategy</h3>
First, we need to decided which traffic we care about. 
I only care about youtube and amazon at this point. And while those two also broadcast a ton of telemetry data 
we'll just have to take the bad with the good here. So outside of those two services, 
the smart tv box should be completely silent and invisible to the outside world.
</p>

To start blocking WAN traffic, we will build a pfBlockerNG rule and isolate  
<a href="https://bgp.he.net/search?search%5Bsearch%5D=google&commit=Search">google</a>/<a href="https://bgp.he.net/search?search%5Bsearch%5D=amazon&commit=Search">amazon</a> 
using <a href="https://en.wikipedia.org/wiki/Autonomous_system_(Internet)">ASN</a>s. 
Upon feed updates, pfBlockerNG will resolve those ASNs to lots of IP addresses belonging to those organizations. 
To make firewall rules easier, first we build a rule that blocks traffic to google/amazon 
and then inverse the source/destination (effectively blocking all other traffic instead).
</p>

<h3>Adding firewall rules</h3>
Navigate to <b>Firewall / pfBlockerNG / IPv4</b>, click Add. Set List Action: Deny Both, on 
Advanced Inbound add IP of your smart TV to Custom Destination, and similarly on 
Advanced Outbound to Custom Source. In IPv4 Custom List tab, check Enable Domain/AS 
and paste following ASNs into Custom Address(es).

<pre>
AS15169
AS36040
AS22577
AS36561
AS14618
AS16509
AS11344
AS19047
AS7224
AS6432
AS16550
AS62785
AS58588
</pre>

Once the rule is saved, run pfBlockerNG update and reload steps on <b>Firewall / pfBlockerNG / Update</b> page. 
The log should state that a few hundred IPs have been added.</p>

pfBlockerNG essentially builds multiple, regular pfSense firewall rules 
which we'll slightly adjust to complete the setup.</p>

On WAN and LAN rules ( <b>Firewall / Rules / WAN</b> ) edit the rule created by pfBlockerNG to Invert match on 
the Source. And similarly on LAN page, modify the rule to Invert match on Destination.</p>

If you still want your smart TV to communicate to other devices on LAN, like Android debugging over WiFi or DNS 
then add a new rule on LAN page, set Action to Pass, Source: smart TV IP, Destination: LAN net, 
and make sure it's above the pfBlockerNG rule. In the end it should look something like this:
</p>
<p style="text-align: center">
<a href="../assets/lan-rules-pfsense.png">
<img src="../assets/lan-rules-pfsense.png" style="width:500; height: auto">
</a>
</p>

<h3>Testing</h3>
When all is done, you can see successful traffic blocks by checking <b>Firewall / pfBlockerNG / Alerts</b>
</p>
<p style="text-align: center">
<a href="../assets/pfsense-block-results.png">
<img src="../assets/pfsense-block-results.png" style="width:500; height: auto">
</a>
</p>

Another way to test is to block a different device on your network, like a smart phone, and verify that 
you can still reach youtube and amazon but nothing else.